package Lab1;

import java.util.Arrays;

public class GLIBC {
    private int MAX;
    private int seed;
    //            2^31 = 2147483647 - 1
    private static final int modulo = 2147483647;
    private static final int multiplier = 16807;
    private static final int firstBound = 31;
    private static final int secondBound = 34;
    private static final int thirdBound = 344;
    private static final int maxSeed = 100000;

    /**
     * @param MAX  Elements in output string.
     * @param seed An seed used to generator. It is used to distinguish outputs.
     * @throws Exception When arguments are negative.
     */
    public GLIBC(int MAX, int seed) throws Exception {
        if (MAX < thirdBound) throw new Exception("String should be longer.");
        if (seed < 0) throw new Exception("String of negative seed cannot be generated.");
        this.MAX = MAX;
        this.seed = seed;
    }

    /**
     * Constructs a generator with default size of string and default seed.
     */
    public GLIBC() {
        this.MAX = 1000;
        this.seed = 1;
    }

    /**
     * @return String generated by the GLIBC's random method with parameters given to the constructor.
     */
    public String generateString() {

        StringBuilder output = new StringBuilder();
        int[] r = new int[this.MAX];

        r[0] = this.seed;
        for (int i = 1; i < firstBound; i++) {
            r[i] = (multiplier * r[i - 1]) % modulo;
            if (r[i] < 0) {
                r[i] += modulo;
            }
        }
        System.arraycopy(r, 0, r, firstBound, secondBound - firstBound);

        for (int i = secondBound; i < thirdBound; i++) {
            r[i] = r[i - firstBound] + r[i - 3];
        }

        for (int i = thirdBound; i < this.MAX; i++) {
            r[i] = r[i - firstBound] + r[i - 3];
            output.append(r[i] >> 1);
            output.append("_");
        }
        return output.toString();
    }

    /**
     * Distinguishes if given string was created by the GLIBC generator.
     *
     * @param str String to perform operation.
     * @return True if string can be generated by the GLIBC method.
     */
    public static boolean isGLIBC(String str) {
        int[] numbers = Arrays.stream(str.split("_")).mapToInt(Integer::parseInt).toArray();
        int s = 1;
        int Limit = numbers.length + GLIBC.thirdBound;

        while (s < GLIBC.maxSeed) {

            StringBuilder STR = new StringBuilder();
            int[] ccc = new int[Limit];

            ccc[0] = s;
            for (int i = 1; i < GLIBC.firstBound; i++) {
                ccc[i] = (GLIBC.multiplier * ccc[i - 1]) % GLIBC.modulo;
                if (ccc[i] < 0) {
                    ccc[i] += GLIBC.modulo;
                }
            }

            for (int i = GLIBC.firstBound; i < GLIBC.secondBound; i++) {
                ccc[i] = ccc[i - GLIBC.firstBound];
            }

            for (int i = GLIBC.secondBound; i < GLIBC.thirdBound; i++) {
                ccc[i] = ccc[i - GLIBC.firstBound] + ccc[i - 3];
            }

            for (int i = GLIBC.thirdBound; i < Limit; i++) {
                ccc[i] = ccc[i - GLIBC.firstBound] + ccc[i - 3];
                STR.append(ccc[i] >> 1);
                STR.append("_");
            }
            if (STR.toString().equals(str))
                return true;

            s++;
        }
        return false;
    }
}